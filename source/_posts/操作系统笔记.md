---
title: 操作系统笔记
categories: learning-notes
excerpt: 如题，操作系统笔记
hide: true
tag: markdown
---
{% note warning %}
{% endnote %} 

操作系统定义：
- 一个控制程序
- 一个资源管理器

操作系统内核特征：
- 并发，计算机系统中同时存在多个运行的程序，需要OS管理和调度
- 共享，同时访问，互斥共享
- 虚拟，利用多道程序设计技术，
- 异步，服务完成的时间不确定，也可能失败（进程的异步）

演化历史：
1. 单用户系统
2. 批处理系统
3. 多道程序系统
4. 分时系统
5. 分布式系统（AloT）

操作系统的结构:
- 简单结构：MS-DOS应用和OS混在一起，使用汇编
- 单体分层结构，第0层，硬件；最高层，用户接口，每一层只使用低一层提供的服务
- 微内核结构，尽可能把内核功能移到用户空间（解决分层的效率低），灵活且安全，但性能下降

中断，异常和系统调用
- 中断：来自硬件设备的处理请求，异步，对应用程序透明
- 异常：非法指令或其他原因导致当前指令执行失败，同步，杀死或重新执行意外的应用程序指令
- 系统调用：应用程序主动向操作系统发出的请求，异步或同步，等待和持续。执行系统调用的过程：`传递系统调用参数->执行陷入指令->执行相应的服务程序->返回用户态`

进程：
- 进程与程序的关系：
  - 程序=文件
  - 任务（进程）=执行中的程序=程序+执行状态
- 所需的资源：内存（保存代码和数据）和CPU（执行指令）
- 组成：数据，PCB，程序
  - 任务控制块（TCB，也称process control block,PCB），每个任务在操作系统中有一个对于的PCB
  - PCB的组织：同一状态进程的PCB成一个链表
- 特点：动态性，独立性，制约性，并发性
- 通过对PCB的组织管理实现对进程的组织管理
- 进程**创建**（系统初始化，用户请求创建新进程，在执行的进程创建了进程），进程**等待（阻塞）**（一定是自我阻塞），进程**抢占**（高优先级进程就绪），进程**唤醒**（只能被其他进程或操作系统唤醒）
- 进程的五个状态：创建，退出，就绪（阻塞），运行，等待（一般说三个状态指后三个）。退出一定是从运行转为退出。此外还有七态模型，增加就绪挂起（进程在外存，只要进入内存即可运行），等待挂起（进程在外存并等待某事件出现），挂起是将进程放到外存
![](../img/操作系统笔记/进程5态.png)

---

内存管理
- 内存管理的方式：重定位，分段，分页，虚拟存储
- 连续内存分配：给应用分配一块不小于指定大小的连续内存空间。外部碎片（**分配单元间**未被使用的内存）；内部碎片（**分配单元内**未被使用的内存）。
  - 固定分区，会产生内部碎片
  - 动态分区（最先匹配First-fit，最佳匹配Best-fit，最差匹配Worst-fit，下次匹配Next-fit）
    - First-fit：简单；外部碎片多
    - Best-fit：大部分分配的尺寸较小时，效果很好；外部碎片多，释放分区慢（链表查找），小碎片多
    - Worst-fit：小碎片少；释放分区慢，没有大的空间 
  - Buddy（伙伴系统），按照$2^{i}$分配与合并，在合并时怎么分的怎么合并
- 非连续内存分配：将一个进程放在内存中不一定连续的位置
  - 简单分段
    - 类似于动态分区，不要求所有段的长度都相等。段表放在段表寄存器中，段表中放有段表项（基址和长度）。给定一个n+m位地址，左边n位是段号，右边m位是偏移量，则段长最大$2^{m}$，在段表中查找段号对应段的物理地址起始位置，将偏移量和段表项中的段长度对比，可能无效，若有效则物理地址为起始物理地址+偏移量
  - 简单分页
    - 每一页的长度相等。页面（逻辑地址等分）到页帧（物理地址等分），实际是逻辑地址到物理地址的转化。给定一个n+m位地址，左边n位是页号，右边m位是偏移量，则一页的大小为$2^{m}$B，一个程序最多有$2^{n}$页，通过页号查找页表中对应的叶帧号**物理地址**为$2^{m}*$页帧号+偏移量
    - 存在访问性能和页表容量过大的问题。性能问题通过缓存和间接访问方式解决，快表（Translation Look-aside Buffer,TLB）缓存近期访问的页表项。在进程切换时，TLB可以清空（不同进程的逻辑地址可能相同），也可以添加地址空间标识符（Address Space Identifier,ASID）；页表容量过大通过多级页表和反置页表解决
      - 多级页表。一级页表号也叫页目录号，通过一级页表号在一级页表（页表项存二级页表位置）中找到二级页表起始位置，通过二级页表号在二级页表找到三级页表起始位置或叶帧号
      - 反置页表。整个系统一个反置页表，给定一个n+m位地址，前n位与PID进行hash在反置页表中，找到对应的页表项（页表项存有页号，PID，next(供冲突使用)）
    - 注：每个进程有一个页表，整个操作系统只有一个TLB
  - 段页式存储管理。内存共享，段S在两个进程中的段号不一定相同，在共享段表和物理内存中是同一个
  - 虚存分页
  - 虚存分段


![](../img/操作系统笔记/内存分配.png)